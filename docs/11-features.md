# 機能設計

## 機能一覧

| # | 機能 | 優先度 | フェーズ |
|---|------|--------|---------|
| F0 | 設定エクスポート | 高 | Phase 1 |
| F1 | システムトレイ常駐 | 高 | Phase 1 |
| F2 | 作業終了通知 | 高 | Phase 1 |
| F3 | 承認依頼・質問通知 | 高 | Phase 2 |
| F4 | セッション状態表示（トレイツールチップ） | 中 | Phase 2 |
| F5 | ダッシュボードウィンドウ | 中 | Phase 3 |
| F6 | 使用量・トークン残量表示 | 中 | Phase 3 |
| F7 | 複数セッション管理 | 低 | Phase 3 |
| F8 | 通知設定カスタマイズ | 低 | 将来 |

---

## F0: 設定エクスポート

### 概要

Windowsアプリ上で設定を入力し、Claude Code環境にコピーすべきファイルをエクスポートする。
これによりユーザーのセットアップ体験を簡略化する。

### 仕様

#### 設定画面

```
┌─────────────────────────────────────────┐
│  Claude Code 接続設定                    │
├─────────────────────────────────────────┤
│                                         │
│  ブローカー設定                          │
│  ┌─────────────────────────────────────┐│
│  │ ホスト: [自動検出: 192.168.1.100   ]││
│  │ ポート: [1883                      ]││
│  └─────────────────────────────────────┘│
│                                         │
│  MQTTクライアント種別                    │
│  ○ mosquitto_pub（推奨）                │
│  ○ Python (paho-mqtt)                   │
│  ○ Node.js (mqtt)                       │
│                                         │
│  [エクスポート]                          │
│                                         │
└─────────────────────────────────────────┘
```

#### 入力項目

| 項目 | 説明 | デフォルト値 |
|------|------|-------------|
| ホスト | WindowsアプリのIPアドレス | 自動検出 |
| ポート | MQTTブローカーのポート | 1883 |
| クライアント種別 | Claude Code側で使用するMQTTクライアント | mosquitto_pub |

#### エクスポート内容

1. **Hooksスクリプト**
   - `on-stop.sh` - 作業終了通知用
   - `on-notification.sh` - 承認依頼・質問通知用
   - `on-session-start.sh` - セッション開始通知用

2. **Statuslineスクリプト**
   - `statusline.sh` - セッション状態送信用

3. **Claude Code設定スニペット**
   - `settings.json` に追加するHooks/Statusline設定

4. **セットアップ手順書**
   - `README.txt` - インストール手順

#### エクスポート形式

ZIPファイルまたはフォルダとしてエクスポート。

```
claude-code-notify-config/
├── scripts/
│   ├── hooks/
│   │   ├── on-stop.sh
│   │   ├── on-notification.sh
│   │   └── on-session-start.sh
│   └── statusline.sh
├── settings-snippet.json
└── README.txt
```

---

## F1: システムトレイ常駐

### 概要

Windowsのタスクバー右下（通知領域）にアイコンを表示し、常駐する。
アプリ起動時にMQTTブローカーも自動的に起動する。

### 仕様

#### トレイアイコン

- アイコン: Claude Codeを示すアイコン（.ico形式）
- ツールチップ: アプリ名とステータスを表示

#### コンテキストメニュー（右クリック）

```
┌────────────────────┐
│ ダッシュボードを開く │
├────────────────────┤
│ 設定エクスポート    │
├────────────────────┤
│ 通知を一時停止      │
├────────────────────┤
│ 設定               │
├────────────────────┤
│ 終了               │
└────────────────────┘
```

#### 動作

- アプリ起動時にMQTTブローカー（rumqttd）を起動
- アプリ起動時にトレイアイコンを表示
- MQTTトピックをサブスクライブ
- 「終了」選択でアプリとブローカーを終了
- ウィンドウを閉じてもトレイに常駐（終了しない）

---

## F2: 作業終了通知

### 概要

Claude Codeが応答を完了した際（Stopイベント）にWindows通知を表示する。

### 仕様

#### 通知内容

```
┌─────────────────────────────────────┐
│ 🤖 Claude Code                      │
├─────────────────────────────────────┤
│ 作業が完了しました                    │
│                                     │
│ プロジェクト: /home/user/myproject   │
└─────────────────────────────────────┘
```

#### トリガー条件

- MQTTトピック `claude-code/events/stop` にメッセージを受信した時
- セッションが新規（SessionStart後の初回Stop）ではない場合のみ通知

#### 動作

1. Claude Code: Stopフック実行
2. Hooksスクリプト: `mosquitto_pub` で `claude-code/events/stop` にパブリッシュ
3. Tauri: MQTTメッセージを受信
4. Tauri: Windows Toast通知を表示

---

## F3: 承認依頼・質問通知

### 概要

Claude Codeが承認を求めている時や質問をしている時に通知を表示する。

### 仕様

#### 通知内容

```
┌─────────────────────────────────────┐
│ 🤖 Claude Code - 確認待ち            │
├─────────────────────────────────────┤
│ 承認が必要です                       │
│                                     │
│ プロジェクト: /home/user/myproject   │
└─────────────────────────────────────┘
```

#### トリガー条件

- MQTTトピック `claude-code/events/notification` にメッセージを受信した時
- `notification_type` が承認依頼または質問の場合

---

## F4: セッション状態表示（トレイツールチップ）

### 概要

トレイアイコンにマウスを乗せた時に現在のセッション状態を表示する。

### 仕様

#### ツールチップ内容

```
Claude Code Monitor
────────────────────
アクティブセッション: 2
コスト合計: $0.15
Context平均: 45%
```

#### 更新タイミング

- MQTTトピック `claude-code/status/#` でメッセージを受信した時

---

## F5: ダッシュボードウィンドウ

### 概要

詳細な情報を表示するウィンドウ。トレイアイコンのダブルクリックまたはメニューから開く。

### 仕様

#### 表示内容

```
┌────────────────────────────────────────────────────────────┐
│  Claude Code Monitor                              [─][□][×]│
├────────────────────────────────────────────────────────────┤
│                                                            │
│  📊 使用量サマリー                                          │
│  ┌──────────────────────────────────────────────────────┐  │
│  │ 本日のコスト: $0.35    トークン: 45,000               │  │
│  └──────────────────────────────────────────────────────┘  │
│                                                            │
│  📋 アクティブセッション                                    │
│  ┌──────────────────────────────────────────────────────┐  │
│  │ # │ プロジェクト      │ Context │ モード  │ 編集行  │  │
│  ├───┼──────────────────┼─────────┼────────┼─────────┤  │
│  │ 1 │ /home/user/proj1 │ 45%     │ default│ +50/-10 │  │
│  │ 2 │ /home/user/proj2 │ 22%     │ plan   │ +120/-5 │  │
│  └──────────────────────────────────────────────────────┘  │
│                                                            │
└────────────────────────────────────────────────────────────┘
```

#### 表示項目

| 項目 | 説明 | データソース |
|------|------|-------------|
| プロジェクト | 作業ディレクトリ | `cwd` |
| Context | コンテキスト使用率(%) | `context_window.used_percentage` |
| モード | 権限モード | `permission_mode` |
| 編集行 | 追加/削除行数 | `lines.added/removed` |
| コスト | セッションコスト | `cost.total_cost_usd` |

---

## F6: 使用量・トークン残量表示

### 概要

現在の使用量とトークン制限までの残量を表示する。

### 仕様

#### 表示内容

- 本日の累計コスト
- 累計トークン使用量
- コンテキストウィンドウ使用率

#### データソース

MQTTで受信する `cost` および `context_window` 情報。

### 注意事項

- トークン制限（レート制限）はStatuslineでは取得できない
- 現時点では各セッションのコンテキスト使用率のみ表示可能
- レート制限情報はClaude CodeのAPIからは直接取得できないため、将来の拡張課題とする

---

## F7: 複数セッション管理

### 概要

複数のClaude Codeセッションを同時に監視・表示する。

### 仕様

#### セッション識別

- `session_id` でセッションを一意に識別
- MQTTトピック: `claude-code/status/{session_id}`

#### セッションライフサイクル

1. `claude-code/events/session-start` 受信でセッション登録
2. `claude-code/status/{session_id}` 受信で状態を更新
3. 一定時間更新がない場合、非アクティブとしてマーク
4. `claude-code/events/session-end` 受信でセッション削除

---

## F8: 通知設定カスタマイズ（将来）

### 概要

通知の種類や頻度をユーザーがカスタマイズできる。

### 仕様（案）

- 通知の有効/無効切り替え（イベント種類ごと）
- 通知音の設定
- 通知の重複防止（一定時間内の同種通知をまとめる）


<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
